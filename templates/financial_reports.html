{% extends "base.html" %}

{% block title %}Financial Reports - Insight of Stock{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
                    <li class="breadcrumb-item active">Financial Reports</li>
                </ol>
            </nav>
            
            <h1 class="mb-4">Financial Reports</h1>
            
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="balance-sheet-tab" data-bs-toggle="tab" data-bs-target="#balance-sheet" type="button" role="tab">Balance Sheet</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="income-statement-tab" data-bs-toggle="tab" data-bs-target="#income-statement" type="button" role="tab">Income Statement</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cash-flow-tab" data-bs-toggle="tab" data-bs-target="#cash-flow" type="button" role="tab">Cash Flow</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="reportTabsContent">
                        <!-- Balance Sheet Tab -->
                        <div class="tab-pane fade show active" id="balance-sheet" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <label for="balanceSheetTicker" class="form-label">Stock Code:</label>
                                    <input type="text" class="form-control autocomplete-ticker" id="balanceSheetTicker" placeholder="Enter TS_CODE (e.g., 000001.SZ)" style="width: 300px; display: inline-block;" data-target="balanceSheet">
                                    <button class="btn btn-primary ms-2" onclick="loadBalanceSheet()">Load</button>
                                    <div class="autocomplete-items" id="balanceSheetAutocompleteList"></div>
                                </div>
                            </div>
                            <div id="balanceSheetTable">
                                <div class="text-center">
                                    <p>Please enter a stock code and click "Load" to view balance sheet data.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Income Statement Tab -->
                        <div class="tab-pane fade" id="income-statement" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <label for="incomeStatementTicker" class="form-label">Stock Code:</label>
                                    <input type="text" class="form-control autocomplete-ticker" id="incomeStatementTicker" placeholder="Enter TS_CODE (e.g., 000001.SZ)" style="width: 300px; display: inline-block;" data-target="incomeStatement">
                                    <button class="btn btn-primary ms-2" onclick="loadIncomeStatement()">Load</button>
                                    <div class="autocomplete-items" id="incomeStatementAutocompleteList"></div>
                                </div>
                            </div>
                            <div id="incomeStatementTable">
                                <div class="text-center">
                                    <p>Please enter a stock code and click "Load" to view income statement data.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cash Flow Tab -->
                        <div class="tab-pane fade" id="cash-flow" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <label for="cashFlowTicker" class="form-label">Stock Code:</label>
                                    <input type="text" class="form-control autocomplete-ticker" id="cashFlowTicker" placeholder="Enter TS_CODE (e.g., 000001.SZ)" style="width: 300px; display: inline-block;" data-target="cashFlow">
                                    <button class="btn btn-primary ms-2" onclick="loadCashFlow()">Load</button>
                                    <div class="autocomplete-items" id="cashFlowAutocompleteList"></div>
                                </div>
                            </div>
                            <div id="cashFlowTable">
                                <div class="text-center">
                                    <p>Please enter a stock code and click "Load" to view cash flow data.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Autocomplete functionality
let tickerSuggestions = [];

document.addEventListener('DOMContentLoaded', function() {
    loadTickerSuggestions();
    
    // Add event listeners to autocomplete inputs
    document.querySelectorAll('.autocomplete-ticker').forEach(input => {
        input.addEventListener('input', function() {
            const target = this.getAttribute('data-target');
            const val = this.value;
            let listContainer = document.getElementById(target + 'AutocompleteList');
            
            // Close any already open lists of autocompleted values
            closeAllLists();
            
            if (!val) { return false; }
            if (val.length < 2) { return false; }
            
            // Create a DIV element that will contain the items (values):
            const autocompleteList = document.createElement("DIV");
            autocompleteList.setAttribute("id", this.id + "autocomplete-list");
            autocompleteList.setAttribute("class", "autocomplete-items");
            // Append the DIV element as a child of the autocomplete container:
            this.parentNode.appendChild(autocompleteList);
            
            // For each item in the tickerSuggestions array:
            tickerSuggestions.forEach(item => {
                if (item.toUpperCase().includes(val.toUpperCase())) {
                    // Create a DIV element for each matching element:
                    const suggestionItem = document.createElement("DIV");
                    // Make the matching letters bold:
                    const startIndex = item.toUpperCase().indexOf(val.toUpperCase());
                    const endIndex = startIndex + val.length;
                    suggestionItem.innerHTML = 
                        "<strong>" + item.substr(0, startIndex) + "</strong>" +
                        "<strong>" + item.substr(startIndex, val.length) + "</strong>" +
                        "<strong>" + item.substr(endIndex) + "</strong>";
                    suggestionItem.innerHTML += "<input type='hidden' value='" + item + "'>";
                    // Execute a function when someone clicks on the item value (DIV element):
                    suggestionItem.addEventListener("click", function(e) {
                        // Insert the value for the autocomplete text field:
                        input.value = this.getElementsByTagName("input")[0].value;
                        // Close the autocomplete list:
                        closeAllLists();
                    });
                    autocompleteList.appendChild(suggestionItem);
                }
            });
        });
        
        // Close the autocomplete list when clicking elsewhere
        document.addEventListener("click", function (e) {
            closeAllLists();
        });
    });
});

function loadTickerSuggestions() {
    fetch('/api/tickers?suggest=true')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                tickerSuggestions = data.data.map(ticker => ticker.ts_code + ' - ' + ticker.name);
            }
        })
        .catch(error => {
            console.error('Error loading ticker suggestions:', error);
        });
}

function closeAllLists(elmnt) {
    // Close all autocomplete lists in the document,
    // except the one passed as an argument
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
        if (elmnt != x[i] && elmnt != input) {
            x[i].parentNode.removeChild(x[i]);
        }
    }
}

function loadBalanceSheet() {
    const ticker = document.getElementById('balanceSheetTicker').value.trim();
    if (!ticker) {
        alert('Please enter a stock code');
        return;
    }
    
    const tableDiv = document.getElementById('balanceSheetTable');
    tableDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    fetch(`/api/financial-reports/${ticker.split(' ')[0]}/balance-sheets`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBalanceSheet(data.data);
            } else {
                tableDiv.innerHTML = `<div class="alert alert-danger">Failed to load balance sheet: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            tableDiv.innerHTML = `<div class="alert alert-danger">Failed to load balance sheet</div>`;
        });
}

function displayBalanceSheet(data) {
    const tableDiv = document.getElementById('balanceSheetTable');
    
    if (!data.balance_sheets || data.balance_sheets.length === 0) {
        tableDiv.innerHTML = '<div class="alert alert-info">No balance sheet data available</div>';
        return;
    }
    
    // Display company info
    let html = `
        <div class="mb-3">
            <h5>${data.name} (${data.symbol}) - ${data.ts_code}</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Report Date</th>
                        <th>Total Assets</th>
                        <th>Total Liabilities</th>
                        <th>Shareholders' Equity</th>
                        <th>Cash & Equivalents</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.balance_sheets.forEach(bs => {
        html += `
            <tr>
                <td>${formatDate(bs.end_date)}</td>
                <td class="text-end">${formatCurrency(bs.total_assets)}</td>
                <td class="text-end">${formatCurrency(bs.total_liab)}</td>
                <td class="text-end">${formatCurrency(bs.total_hldr_eqy_inc_min_int)}</td>
                <td class="text-end">${formatCurrency(bs.money_cap)}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <button class="btn btn-secondary" onclick="showFullBalanceSheet('${data.ts_code}')">View Full Balance Sheet</button>
        </div>
    `;
    
    tableDiv.innerHTML = html;
}

function showFullBalanceSheet(tsCode) {
    // Redirect to a detailed view page or show in a modal
    alert(`Full balance sheet for ${tsCode} would be displayed here in a detailed view.`);
}

function loadIncomeStatement() {
    const ticker = document.getElementById('incomeStatementTicker').value.trim();
    if (!ticker) {
        alert('Please enter a stock code');
        return;
    }
    
    const tableDiv = document.getElementById('incomeStatementTable');
    tableDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    fetch(`/api/financial-reports/${ticker.split(' ')[0]}/income-statements`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayIncomeStatement(data.data);
            } else {
                tableDiv.innerHTML = `<div class="alert alert-danger">Failed to load income statement: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            tableDiv.innerHTML = `<div class="alert alert-danger">Failed to load income statement</div>`;
        });
}

function displayIncomeStatement(data) {
    const tableDiv = document.getElementById('incomeStatementTable');
    
    if (!data.income_statements || data.income_statements.length === 0) {
        tableDiv.innerHTML = '<div class="alert alert-info">No income statement data available</div>';
        return;
    }
    
    // Display company info
    let html = `
        <div class="mb-3">
            <h5>${data.name} (${data.symbol}) - ${data.ts_code}</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Report Date</th>
                        <th>Revenue</th>
                        <th>Gross Profit</th>
                        <th>Net Income</th>
                        <th>EPS</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.income_statements.forEach(is_stmt => {
        const grossProfit = (is_stmt.total_revenue || 0) - (is_stmt.revenue || 0);
        html += `
            <tr>
                <td>${formatDate(is_stmt.end_date)}</td>
                <td class="text-end">${formatCurrency(is_stmt.total_revenue)}</td>
                <td class="text-end">${formatCurrency(grossProfit)}</td>
                <td class="text-end">${formatCurrency(is_stmt.net_profit)}</td>
                <td class="text-end">${is_stmt.basic_eps ? is_stmt.basic_eps.toFixed(2) : 'N/A'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <button class="btn btn-secondary" onclick="showFullIncomeStatement('${data.ts_code}')">View Full Income Statement</button>
        </div>
    `;
    
    tableDiv.innerHTML = html;
}

function showFullIncomeStatement(tsCode) {
    // Redirect to a detailed view page or show in a modal
    alert(`Full income statement for ${tsCode} would be displayed here in a detailed view.`);
}

function loadCashFlow() {
    const ticker = document.getElementById('cashFlowTicker').value.trim();
    if (!ticker) {
        alert('Please enter a stock code');
        return;
    }
    
    const tableDiv = document.getElementById('cashFlowTable');
    tableDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    fetch(`/api/financial-reports/${ticker.split(' ')[0]}/cash-flows`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCashFlow(data.data);
            } else {
                tableDiv.innerHTML = `<div class="alert alert-danger">Failed to load cash flow: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            tableDiv.innerHTML = `<div class="alert alert-danger">Failed to load cash flow</div>`;
        });
}

function displayCashFlow(data) {
    const tableDiv = document.getElementById('cashFlowTable');
    
    if (!data.cash_flows || data.cash_flows.length === 0) {
        tableDiv.innerHTML = '<div class="alert alert-info">No cash flow data available</div>';
        return;
    }
    
    // Display company info
    let html = `
        <div class="mb-3">
            <h5>${data.name} (${data.symbol}) - ${data.ts_code}</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Report Date</th>
                        <th>Operating Cash Flow</th>
                        <th>Investing Cash Flow</th>
                        <th>Financing Cash Flow</th>
                        <th>Net Change in Cash</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.cash_flows.forEach(cf => {
        html += `
            <tr>
                <td>${formatDate(cf.end_date)}</td>
                <td class="text-end ${cf.n_cashflow_act >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(cf.n_cashflow_act)}
                </td>
                <td class="text-end ${cf.n_cashflow_inv_act >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(cf.n_cashflow_inv_act)}
                </td>
                <td class="text-end ${cf.n_cash_flows_fnc_act >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(cf.n_cash_flows_fnc_act)}
                </td>
                <td class="text-end ${cf.n_incr_cash_cash_equ >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(cf.n_incr_cash_cash_equ)}
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <button class="btn btn-secondary" onclick="showFullCashFlow('${data.ts_code}')">View Full Cash Flow</button>
        </div>
    `;
    
    tableDiv.innerHTML = html;
}

function showFullCashFlow(tsCode) {
    // Redirect to a detailed view page or show in a modal
    alert(`Full cash flow for ${tsCode} would be displayed here in a detailed view.`);
}

function formatCurrency(amount) {
    if (!amount) return '¥0';
    // Format as currency with commas and yuan symbol
    return '¥' + parseFloat(amount).toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatDate(dateStr) {
    if (!dateStr || dateStr === 'nan') return 'N/A';
    
    try {
        const year = dateStr.substring(0, 4);
        const month = dateStr.substring(4, 6);
        const day = dateStr.substring(6, 8);
        return `${year}-${month}-${day}`;
    } catch (e) {
        return dateStr;
    }
}
</script>
<style>
/* Style the autocomplete items */
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

.autocomplete-items div:hover {
  /*when hovering an item:*/
  background-color: #e9e9e9; 
}

.autocomplete-active {
  /*when navigating through the items using the arrow keys:*/
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}
</style>
{% endblock %}